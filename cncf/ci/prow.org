#+TITLE: #Prow for cncf-ci
#+AUTHOR: Hippie Hacker
#+EMAIL: hh@ii.coop
#+CREATOR: ii.coop
#+DATE: 8th of March, 2019

* Deploying Prow

Following [[https://github.com/kubernetes/test-infra/blob/master/prow/getting_started_deploy.md][prow/getting_started#Deploying Prow]]:

#+NAME: go get tackle
#+BEGIN_SRC shell :noweb yes :var tmpdir=(symbol-value 'tmpdir)
go get -u k8s.io/test-infra/prow/cmd/tackle
#+END_SRC

** cluster
:PROPERTIES:
:noheader-args:tmate: :socket "/tmp/hippie.packet-setup.iisocket"
:noheader-args:tmate: :session main:prow
:noheader-args:shell+: :dir "/ssh:root@139.178.88.146:"
:END:
[[file:~/ii/org/k8s.io/kubernetes/packet-setup.org::*TLDR][After following the TLDR to setup k8s on Packet]]:

*** ensure GCP user has cluster-admin-binding
#+NAME: giving gcloud account cluster-admin
#+BEGIN_SRC shell
kubectl create clusterrolebinding cluster-admin-binding \
  --clusterrole cluster-admin --user $(gcloud config get-value account)
#+END_SRC

#+RESULTS: giving gcloud account cluster-admin
#+BEGIN_EXAMPLE :noeval t
clusterrolebinding.rbac.authorization.k8s.io/cluster-admin-binding created
#+END_EXAMPLE

*** service account
#+NAME: Setup a Kubernetes Service Account
#+BEGIN_SRC shell
  kubectl --namespace kube-system create serviceaccount cncf-ci
  kubectl create clusterrolebinding cncf-ci \
    --clusterrole cluster-admin \
    --serviceaccount=kube-system:cncf-ci
#+END_SRC

#+RESULTS: Setup a Kubernetes Service Account
#+BEGIN_EXAMPLE :noeval t
serviceaccount/cncf-ci created
clusterrolebinding.rbac.authorization.k8s.io/cncf-ci created
#+END_EXAMPLE

#+NAME: GCLOUD_SERVICE_ACCOUNT
#+BEGIN_SRC shell
  gcloud iam service-accounts create cncf-ci || true
  gcloud iam service-accounts describe cncf-ci@apisnoop.iam.gserviceaccount.com
#+END_SRC

#+RESULTS: GCLOUD_SERVICE_ACCOUNT
#+BEGIN_EXAMPLE :noeval t
email: cncf-ci@apisnoop.iam.gserviceaccount.com
etag: MDEwMjE5MjA=
name: projects/apisnoop/serviceAccounts/cncf-ci@apisnoop.iam.gserviceaccount.com
oauth2ClientId: '117158085094240977692'
projectId: apisnoop
uniqueId: '117158085094240977692'
#+END_EXAMPLE

#+RESULTS: Setup a GCloud Service Account Secret Key
#+BEGIN_SRC shell :results silent
  SERVICE_ACCOUNT=cncf-ci@apisnoop.iam.gserviceaccount.com
  gcloud projects add-iam-policy-binding apisnoop \
           --member serviceAccount:${SERVICE_ACCOUNT} \
           --role=roles/storage.admin
#+END_SRC

#+RESULTS: Export service account key into file
#+BEGIN_SRC shell :results silent
  SERVICE_ACCOUNT=cncf-ci@apisnoop.iam.gserviceaccount.com
  gcloud iam service-accounts keys \
         create ./service-account.json \
         --iam-account=$SERVICE_ACCOUNT \
         --key-file-type=json
#+END_SRC

#+NAME: create gcloud service account k8s secret
#+BEGIN_SRC shell
  SERVICE_ACCOUNT=cncf-ci@apisnoop.iam.gserviceaccount.com
  kubectl create secret generic service-account \
    --from-file=service-account.json
#+END_SRC

#+RESULTS: create gcloud service account k8s secret
#+BEGIN_EXAMPLE :noeval t
secret/service-account created
#+END_EXAMPLE

*** github secrets
**** hmac-token
#+NAME: create github hmac-token
#+BEGIN_SRC shell
  kubectl create secret generic hmac-token \
    --from-literal=hmac=$(openssl rand -hex 20)
#+END_SRC

#+RESULTS: create github hmac-token
#+BEGIN_EXAMPLE :noeval t
secret/hmac-token created
#+END_EXAMPLE

#+NAME: github hmac-token
#+BEGIN_SRC shell :results silent
  kubectl get secret hmac-token  -o json | jq -r .data.hmac | base64 -d
#+END_SRC

**** github oauth-token to cluster

Set GITHUB_OATH_TOKEN with a token created at https://github.com/settings/tokens

#+NAME: save github oauth-token to cluster
#+BEGIN_SRC shell
  GITHUB_OAUTH_TOKEN=SET_ME
  kubectl create secret generic oauth-token \
    --from-literal=oauth=$GITHUB_OAUTH_TOKEN
#+END_SRC

#+RESULTS: save github oauth-token to cluster
#+BEGIN_EXAMPLE :noeval t
secret/oauth-token created
#+END_EXAMPLE

#+NAME: gihub oauth-token
#+BEGIN_SRC shell :results silent
kubectl get secret oauth-token  -o json | jq -r .data.oauth | base64 -d
#+END_SRC
*** deploy basic prow components
**** starter.yaml
[[https://github.com/kubernetes/test-infra/blob/master/prow/cluster/starter.yaml][prow/cluster/starter.yaml]]

#+NAME: basic prow components
#+BEGIN_SRC shell
  kubectl apply -f \
    https://raw.githubusercontent.com/kubernetes/test-infra/master/prow/cluster/starter.yaml 2>&1
  echo $?
#+END_SRC

#+RESULTS: basic prow components
#+BEGIN_EXAMPLE :noeval t
configmap/plugins created
configmap/config created
customresourcedefinition.apiextensions.k8s.io/prowjobs.prow.k8s.io created
deployment.extensions/hook created
service/hook created
deployment.extensions/plank created
deployment.extensions/sinker created
deployment.extensions/deck created
service/deck created
deployment.extensions/horologium created
deployment.extensions/tide created
service/tide created
ingress.extensions/ing created
serviceaccount/deck created
rolebinding.rbac.authorization.k8s.io/deck created
role.rbac.authorization.k8s.io/deck created
serviceaccount/horologium created
role.rbac.authorization.k8s.io/horologium created
rolebinding.rbac.authorization.k8s.io/horologium created
serviceaccount/plank created
role.rbac.authorization.k8s.io/plank created
rolebinding.rbac.authorization.k8s.io/plank created
serviceaccount/sinker created
role.rbac.authorization.k8s.io/sinker created
rolebinding.rbac.authorization.k8s.io/sinker created
serviceaccount/hook created
role.rbac.authorization.k8s.io/hook created
rolebinding.rbac.authorization.k8s.io/hook created
serviceaccount/tide created
role.rbac.authorization.k8s.io/tide created
rolebinding.rbac.authorization.k8s.io/tide created
0
#+END_EXAMPLE

#+NAME: our customized prow deployment
#+BEGIN_SRC shell
  kubectl apply -f prow.yaml | grep -v unchanged 2>&1
  echo $?
#+END_SRC

#+RESULTS: our customized prow deployment
#+BEGIN_EXAMPLE :noeval t
deployment.extensions/hook configured
deployment.extensions/plank configured
deployment.extensions/sinker configured
deployment.extensions/deck configured
deployment.extensions/horologium configured
deployment.extensions/tide configured
0
#+END_EXAMPLE


**** get deployments
#+NAME: prow components
#+BEGIN_SRC shell
  kubectl get deployments
#+END_SRC

#+RESULTS: prow components
#+BEGIN_EXAMPLE :noeval t
NAME         DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
deck         2         2         2            2           51d
hook         2         2         2            2           51d
horologium   1         1         1            1           51d
plank        1         1         1            1           51d
sinker       1         1         1            1           51d
tide         1         1         1            1           51d
#+END_EXAMPLE

**** ingress ip
#+NAME: ingress ip
#+BEGIN_SRC shell
kubectl get ingress ing
#+END_SRC

#+RESULTS: ingress ip
#+BEGIN_EXAMPLE :noeval t
NAME   HOSTS   ADDRESS        PORTS   AGE
ing    *       35.241.26.71   80      2m
#+END_EXAMPLE

#+NAME: ingress ip oneliner
#+BEGIN_SRC shell
  kubectl get ingress ing -o=jsonpath='{.status.loadBalancer.ingress[0].ip}'
#+END_SRC

#+RESULTS: ingress ip oneliner
#+BEGIN_EXAMPLE :noeval t
35.241.26.71
#+END_EXAMPLE

**** ingress status
   :PROPERTIES:
   :header-args:yaml+: :tangle no
   :END:


Note the status: loadbalancer:
#+NAME: ingress ing
#+BEGIN_SRC shell :results output verbatim code :wrap "SRC yaml" :noeval
kubectl get ingress ing -o yaml
#+END_SRC

#+RESULTS: ingress ing
#+BEGIN_SRC yaml :tangle no
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"extensions/v1beta1","kind":"Ingress","metadata":{"annotations":{},"name":"ing","namespace":"default"},"spec":{"rules":[{"http":{"paths":[{"backend":{"serviceName":"deck","servicePort":80},"path":"/*"},{"backend":{"serviceName":"hook","servicePort":8888},"path":"/hook"}]}}]}}
  creationTimestamp: "2019-03-17T17:19:31Z"
  generation: 1
  name: ing
  namespace: default
  resourceVersion: "407666"
  selfLink: /apis/extensions/v1beta1/namespaces/default/ingresses/ing
  uid: d3c8960c-48d8-11e9-87ef-42010a98000e
spec:
  rules:
  - http:
      paths:
      - backend:
          serviceName: deck
          servicePort: 80
        path: /*
      - backend:
          serviceName: hook
          servicePort: 8888
        path: /hook
status:
  loadBalancer: {}
#+END_SRC

**** get ingress yaml

I suspect we are not getting ingress IP's because the Ingress is looking for a loadBalancer.

https://github.com/kubernetes/test-infra/blob/master/prow/cluster/starter.yaml#L400

#+NAME: ing yaml
#+BEGIN_SRC yaml :tangle no
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  namespace: default
  name: ing
spec:
  rules:
  - http:
      paths:
      - path: /* # Correct for GKE, need / on many other distros
        backend:
          serviceName: deck
          servicePort: 80
      - path: /hook
        backend:
          serviceName: hook
          servicePort: 8888
#+END_SRC

*** add the webhook to github

#+NAME: install add-hook
#+BEGIN_SRC shell
  go get -u k8s.io/test-infra/experiment/add-hook
#+END_SRC

#+NAME: add-hook
#+BEGIN_SRC shell
  kubectl get secret oauth-token  -o json | jq -r .data.oauth | base64 -d > oauth-token
  kubectl get secret hmac-token  -o json | jq -r .data.hmac | base64 -d > hmac-token
  # HOOK_URL=http://$(kubectl get ingress ing -o=jsonpath='{.status.loadBalancer.ingress[0].ip}')/hook
  HOOK_URL=http://prow.cncf.ci/hook
  add-hook \
    --hmac-path=hmac-token \
    --github-token-path=oauth-token\
    --hook-url=$HOOK_URL \
    --repo ii/RapuTure \
    --confirm=true #confirm=false to dry run
#+END_SRC

#+RESULTS: add-hook
#+BEGIN_EXAMPLE :noeval t
#+END_EXAMPLE

** configuration

*** install checkconfig
#+BEGIN_SRC shell
go get -u k8s.io/test-infra/prow/cmd/checkconfig
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
#+END_EXAMPLE

*** check the config files
#+BEGIN_SRC shell :results silent
  (
  checkconfig --plugin-config=plugins.yaml --config-path=config.yaml
  ) 2>&1
  echo -n ExitCode: $?
#+END_SRC
*** generate and replace the plugin config map
EDIT ME =>>> [[plugins.yaml][plugins.yaml]]
#+BEGIN_SRC shell :noweb yes
  (
    kubectl create configmap plugins \
      --from-file=plugins.yaml=plugins.yaml --dry-run -o yaml \
    | kubectl replace configmap plugins -f -
  ) 2>&1
  echo -n ExitCode: $?
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
configmap/plugins replaced
ExitCode: 0
#+END_EXAMPLE

*** view-plugins
  :PROPERTIES:
  :header-args:yaml+: :tangle no
  :END:
#+BEGIN_SRC shell :wrap "SRC yaml"
kubectl get configmap plugins -o json | jq -r '.data["plugins.yaml"]'
#+END_SRC
*** generate the config configmap
  :PROPERTIES:
  :header-args:yaml+: :tangle no
  :END:
#+BEGIN_SRC shell :wrap "SRC yaml" :results silent
kubectl create configmap config \
  --from-file=config.yaml=config.yaml --dry-run -o yaml
#+END_SRC

*** generate and replace the prow config map
#+BEGIN_SRC shell
  (
    kubectl create configmap config \
      --from-file=config.yaml=config.yaml --dry-run -o yaml \
    | kubectl replace configmap config -f -
  ) 2>&1
  echo -n ExitCode: $?
#+END_SRC

#+BEGIN_EXAMPLE :noeval t
configmap/config replaced
#+END_EXAMPLE
*** view-config
#+BEGIN_SRC shell :wrap "SRC yaml"
kubectl get configmap config -o json | jq -r '.data["config.yaml"]'
#+END_SRC

*** generate the plugin config map (dry run)
#+BEGIN_SRC shell :wrap "SRC yaml" :results drawer :noweb yes
  kubectl create configmap plugins \
    --from-file=plugins.yaml=plugins.yaml --dry-run -o yaml
#+END_SRC

* plugins.yaml
  :PROPERTIES:
  :header-args:yaml+: :tangle plugins.yaml
  :END:

** update-plugins
  ,bs to tangle, check-config and repla,bsce configmaps
*** tangle

#+BEGIN_SRC elisp :tangle no
(org-babel-tangle)
;;(org-babel-tangle-file buffer-file-name "plugins.yaml")
#+END_SRC

#+RESULTS:
| ~/test-infra/hook-plugin.yaml | ~/test-infra/hook-config.yaml | labels.yaml | plugins.yaml | ~/test-infra/comment.json | github-oauth-config |

*** check
#+BEGIN_SRC shell :results drawer :noweb yes :tangle no
  <<check the config files>>
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
ExitCode: 0
#+END_EXAMPLE

*** replace
#+BEGIN_SRC shell :results drawer :noweb yes :tangle no
  <<generate and replace the plugin config map>>
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
configmap/plugins replaced
ExitCode: 0
#+END_EXAMPLE

** plugins_for_all_repos
[[*generate and replace the plugin config map][generate and replace the plugin config map]]   
#+BEGIN_SRC yaml :tangle no
  - approve
  - assign
  # - blockade # block pull requests from merging if they touch specific files
  - blunderbuss
  # - branchcleaner
  - cat
  # - cherry-pick-unapproved
  - cla
  # - config-updater # updates config/plugin.yaml for prow
  - docs-no-retest
  - dog
  - golint
  - heart
  - help
  - hold
  - label
  - lgtm
  - lifecycle
  # - milestone # needs a milestone group to allow setting milestone
  # - milestonestatus # needs a milestone group configured
  - override
  - owners-label
  # - pony
  # - project_manager
  # - project
  - release-note
  # - require-maching-label
  # - require-sig
  - shrug
  # - sigmention
  - size
  - skip
  # - slackevents
  # - stage
  - trigger
  - verify-owners
  - welcome
  - wip
  - yuks
#+END_SRC

THESE KEYS ==>>> ",bt"
RUN ME =>>>> [[update-plugins][update-plugins]]

** plugins.yaml template
   :PROPERTIES:
   :header-args:yaml+: :tangle no
   :END:

#+BEGIN_SRC yaml :tangle no
plugins:
  # cncf/apisnoop:
  # <<plugins_for_all_repos>>
  ii/apisnoop:
  <<plugins_for_all_repos>>
  ii/openfisca-aotearoa:
  <<plugins_for_all_repos>>
  ii/RapuTure:
  <<plugins_for_all_repos>>
#+END_SRC

** triggers
    
[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::triggers:]] 

#+BEGIN_SRC yaml
triggers:
- repos:
  - apisnoop
  trusted_org: cncf
  join_org_url: "https://git.k8s.io/community/community-membership.md#member"
  only_org_members: true
#+END_SRC

** approve
    
[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::approve:]] 

[[file:~/go/src/k8s.io/test-infra/prow/plugins/approve/approvers/README.md::#%20Reviewers%20and%20Approvers]]    

#+BEGIN_SRC yaml
approve:
- repos:
  - ii-ci/apisnoop
  require_self_approval: false
  ignore_review_state: false
  lgtm_acts_as_approve: true
- repos:
  - cncf/apisnoop
  require_self_approval: false
  ignore_review_state: false
  lgtm_acts_as_approve: true
#+END_SRC

** size

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::size:]] 

#+BEGIN_SRC yaml
# Lower bounds in number of lines changed; XS is assumed to be zero.
size:
  s:   10
  m:   30
  l:   100
  xl:  500
  xxl: 1000
#+END_SRC

** label

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::label:]] 

#+BEGIN_SRC yaml
label:
  additional_labels:
    - area/apisnoop
    - lang/markdown
    - api-review
    - conformance-promotion
#+END_SRC
** labels.yaml
  [[file:~/go/src/k8s.io/test-infra/label_sync/labels.yaml]] 
 [[file:~/go/src/k8s.io/test-infra/label_sync/README.md::##%20Usage]]
#+BEGIN_SRC tmate
bazel run //label_sync -- \
  --config ~/org/cncf/ci/labels.yaml \
  --token ~/github-oauth \
  --orgs ii-ci
#+END_SRC
#+BEGIN_SRC shell :eval no-export :async :dir ~/go/src/k8s.io/test-infra
bazel run //label_sync -- \
  --config ~/org/cncf/ci/labels.yaml \
  --token ~/github-oauth \
  --orgs ii-ci
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
#+END_EXAMPLE

#+BEGIN_SRC yaml :tangle labels.yaml
---
default:
  labels:
    - color: e11d21
      description: default-label
      name: default-label
      target: both
      prowPlugin: label
      addedBy: anyone
    - color: f9d0c4
      description: ¯\\\_(ツ)_/¯
      name: "¯\\_(ツ)_/¯"
      target: both
      prowPlugin: shrug
      addedBy: humans
repos:
  ii-ci/apisnoop:
    labels:
      - color: 0052cc
        description: apisnoop-label
        name: apisnoop-label
        target: both
        addedBy: label
#+END_SRC

** lgtm

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::lgtm:]] 
    
#+BEGIN_SRC yaml
lgtm:
- repos:
  - ii-ci/apisnoop
  - cncf/apisnoop
  review_acts_as_lgtm: true
  store_tree_hash: true
#+END_SRC

** blockades

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::blockades:]] 

#+BEGIN_SRC yaml
blockades:
- repos:
  - ii-ci/apisnoop
  - cncf/apisnoop
  blockregexps:
  - ^dev/
  explanation: "dev/ was deprecated"
#+END_SRC

** blunderbuss

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::blunderbuss:]] 
    
#+BEGIN_SRC yaml
blunderbuss:
  max_request_count: 2
#+END_SRC

** repo_milestones
    
[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::repo_milestone:]] 
    
#+BEGIN_SRC yaml
repo_milestone:
  '':
    maintainers_id: 2045178
    maintainers_team: cncf-contractors
  ii-ci/apisnoop:
    maintainers_id: 3230820
    maintainers_team: automation
  cncf/apisnoop:
    maintainers_id: 2045178
    maintainers_team: cncf-contractors
#+END_SRC

** welcome
    
[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::welcome:]] 

#+BEGIN_SRC yaml
welcome:
- repos:
  - apisnoop
  message_template: "Welcome @{{.AuthorLogin}}! <br><br>It looks like this is your first PR to <a href='https://github.com/{{.Org}}/{{.Repo}}'>{{.Org}}/{{.Repo}}</a> 🎉 PARTY. Please refer to our [pull request process documentation](https://git.k8s.io/community/contributors/guide/pull-requests.md) to help your PR have a smooth ride to approval. <br><br>You will be prompted by a bot to use commands during the review process. Do not be afraid to follow the prompts! It is okay to experiment. [Here is the bot commands documentation](https://go.k8s.io/bot-commands). <br><br>You can also check if {{.Org}}/{{.Repo}} has [its own contribution guidelines](https://github.com/{{.Org}}/{{.Repo}}/tree/master/CONTRIBUTING.md). <br><br>You may want to refer to our [testing guide](https://git.k8s.io/community/contributors/devel/sig-testing/testing.md) if you run into trouble with your tests not passing. <br><br>If you are having difficulty getting your pull request seen, please follow the [recommended escalation practices](https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md#why-is-my-pull-request-not-getting-reviewed). Also, for tips and tricks in the contribution process you may want to read the [Kubernetes contributor cheat sheet](https://git.k8s.io/community/contributors/guide/contributor-cheatsheet/README.md). We want to make sure your contribution gets all the attention it needs! <br><br>Thank you, and welcome to Kubernetes. :smiley:"
#+END_SRC

** require_matching_label

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::require_matching_label:]] 

#+BEGIN_SRC yaml
require_matching_label:
- missing_label: data-gen
  org: apisnoop
  repo: apisnoop
  prs: true
  regexp: ^data-gen/
  missing_comment: "Must tag with data-gen to modify anything under ./data-gen/"
#+END_SRC

** plugins

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::plugins:]]

#+BEGIN_SRC yaml
plugins:
  cncf/apisnoop:
  - approve  # Allow OWNERS to /approve
  - assign  # Allow /assign and /cc
  - blockade
  - blunderbuss  # Auto-assign people
  - cat # /meow replies with cat pictures
  - cherry-pick-unapproved
  - cla
  - dog # /bark replies with dog pictures
  - heart
  - help  # Support /help and /good-first-issue
  - hold  # Support /hold to delay merge
  - label
  - lgtm  # Allow /lgtm
  - lifecycle  # Allow /lifecycle stale
  - milestone
  - milestonestatus
  - owners-label
  - override
  - owners-label
    # - project
  - pony
  # - release-note
  # - require-sig
  - require-matching-label
  - shrug
  - sigmention
  - stage
  - skip
  - size  # Auto-label size of PR
  - trigger  # Allow people to configure CI jobs to /test
  - verify-owners # Validates OWNERS file changes in PRs.
  - welcome
  - wip  # Auto-hold PRs with WIP in title
  - yuks # Let prow tell a /joke
  ii-ci/apisnoop:
  - approve  # Allow OWNERS to /approve
  - assign  # Allow /assign and /cc
  - blockade
  - blunderbuss  # Auto-assign people
  - cat # /meow replies with cat pictures
  - cherry-pick-unapproved
  - cla
  - dog # /bark replies with dog pictures
  - heart
  - help  # Support /help and /good-first-issue
  - hold  # Support /hold to delay merge
  - label
  - lgtm  # Allow /lgtm
  - lifecycle  # Allow /lifecycle stale
  - milestone
  - milestonestatus
  - owners-label
  - override
  - owners-label
    # - project
  - pony
  # - release-note
  - require-sig
  - require-matching-label
  - shrug
  - sigmention
  - stage
  - skip
  - size  # Auto-label size of PR
  - trigger  # Allow people to configure CI jobs to /test
  - verify-owners # Validates OWNERS file changes in PRs.
  - welcome
  - wip  # Auto-hold PRs with WIP in title
  - yuks # Let prow tell a /joke
#+END_SRC

** project_config

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::project_config:]]

[[file:~/go/src/k8s.io/test-infra/prow/plugins/config.go::type%20ProjectConfig%20struct]]

We need to find the team_id.
https://developer.github.com/v3/teams/#list-teams
https://github.com/orgs/ii/teams/maintainer_team/members

 /orgs/:org/teams/:team_slug
curl /orgs/ii/teams/maintainer_team

#+BEGIN_SRC shell :tangle no
. ~/githubtoken
curl --user hh:$GITHUB_TOKEN  -H "Accept:application/vnd.github.inertia-preview+json" \
 https://api.github.com/orgs/cncf/teams/cncf-contractors | jq .id
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
2045178
#+END_EXAMPLE

#+BEGIN_SRC shell :tangle no
curl --user hh:$GITHUB_TOKEN  -H "Accept:application/vnd.github.inertia-preview+json" https://api.github.com/repos/ii/apisnoop/teams | jq .[0].id
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
#+END_EXAMPLE

#+BEGIN_SRC yaml
project_config:
  project_org_configs:
    ii-ci:
      org_maintainers_team_id: 3230820
      org_default_column_map:
        org_project1:
          column1
          column2
          column3
        org_project2:
          column1
          column2
          column3
      project_repo_configs:
        apisnoop:
          repo_maintainers_team_id: 3230820
          repo_default_column_map:
            project1:
              column1
              column2
              column3
            project2:
              column1
              column2
              column3
#+END_SRC
** project_manager

#+BEGIN_SRC yaml :noweb yes :tangle plugins.yaml
# project_manager:
#   org/repos:
#     ii/apisnoop:
#       projects:
#         testProject:
#           columns:
#           - name: "triage"
#             state: open
#             org: ii
#             labels:
#             - area/conformance
#+END_SRC
** config_updater

[[file:~/go/src/k8s.io/test-infra/prow/plugins.yaml::config_updater:]]

I don't think we are ready for this
[[file:~/go/src/k8s.io/test-infra/label_sync/README.md::##%20Usage]]

#+BEGIN_SRC yaml :tangle no
config_updater:
  maps:
    label_sync/labels.yaml:
      name: label-config
      namespace: test-pods
    prow/config.yaml:
      name: config
    prow/plugins.yaml:
      name: plugins
    config/jobs/**/*.yaml:
      name: job-config
      gzip: true
    experiment/test-configmap.txt:
      name: test-configmap
      gzip: true
#+END_SRC

* config.yaml
  :PROPERTIES:
  :header-args:yaml+: :tangle config.yaml
  :END:
  
Initially config is empty and plugins only contains size:
** update-config
  ,bs to tangle, check-config and repla,bsce configmaps
*** tangle

#+BEGIN_SRC elisp :tangle no :eval prompt
  ;; (org-babel-tangle)
  (org-babel-tangle-file buffer-file-name)
  ;;(org-babel-tangle-file buffer-file-name "plugins.yaml")
#+END_SRC

#+RESULTS:

*** check
#+BEGIN_SRC shell :results code :noweb yes :tangle no :wrap "SRC text"
  <<check the config files>>
#+END_SRC

#+RESULTS:
#+BEGIN_SRC text
ExitCode: 0
#+END_SRC

*** replace AND restart
#+BEGIN_SRC shell :results drawer :noweb yes :tangle no :async
  <<generate and replace the prow config map>>
  echo
  <<generate and replace the plugin config map>>
  <<delete old pods>>
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
configmap/config replaced
ExitCode: 0
configmap/plugins replaced
ExitCode: 0pod "hook-65ccc7f796-5mrvg" deleted
pod "hook-65ccc7f796-85gms" deleted
pod "plank-bfcd55c74-kbj88" deleted
#+END_EXAMPLE

** restart pods
*** delete old pods
#+BEGIN_SRC shell :async
kubectl delete pods --namespace=default -l app=hook
kubectl delete pods --namespace=default -l app=plank
#+END_SRC

#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
pod "hook-86d9f6dfc6-2kh8f" deleted
pod "hook-86d9f6dfc6-5p4lc" deleted
pod "plank-564d8c4b8b-86cq6" deleted
#+END_EXAMPLE

** logging

#+BEGIN_SRC tmate
  
  kubectl get pods --namespace=default -l app=hook -o name \
  | sed s:pod/:: \
  | xargs -n 1 -P 5 kubectl logs -f \
  | grep -v /etc/config/config.yalm
  # | jq -c -S
#+END_SRC
** debugging
A guy on a channel said

#+BEGIN_SRC yaml
log_level: debug
#+END_SRC
** deck
#+BEGIN_SRC yaml
# https://github.com/kubernetes/test-infra/issues/11729
#time="2019-03-18T07:06:59+13:00" level=fatal msg="Error loading Prow config."
# component=checkconfig error="no default decoration config provided for plank"
deck:
  spyglass:
    size_limit: 500e+6 # 500MB
    viewers:
      "started.json|finished.json": ["metadata"]
      "build-log.txt": ["buildlog"]
      "artifacts/junit.*\\.xml": ["junit"]
      # Remember to escape your '\' in yaml strings!
#+END_SRC
** plank
#+BEGIN_SRC yaml
plank:
  job_url_template: 'https://job_url_template/'
  #  job_url_template: '{{if .Spec.Refs}}{{if eq .Spec.Refs.Org "kubernetes-security"}}https://console.cloud.google.com/storage/browser/kubernetes-security-prow/{{else}}https://prow.k8s.io/view/gcs/kubernetes-jenkins/{{end}}{{else}}https://prow.k8s.io/view/gcs/kubernetes-jenkins/{{end}}{{if eq .Spec.Type "presubmit"}}pr-logs/pull{{else if eq .Spec.Type "batch"}}pr-logs/pull{{else}}logs{{end}}{{if .Spec.Refs}}{{if ne .Spec.Refs.Org ""}}{{if ne .Spec.Refs.Org "kubernetes"}}/{{if and (eq .Spec.Refs.Org "kubernetes-sigs") (ne .Spec.Refs.Repo "poseidon")}}sigs.k8s.io{{else}}{{.Spec.Refs.Org}}{{end}}_{{.Spec.Refs.Repo}}{{else if ne .Spec.Refs.Repo "kubernetes"}}/{{.Spec.Refs.Repo}}{{end}}{{end}}{{end}}{{if eq .Spec.Type "presubmit"}}/{{with index .Spec.Refs.Pulls 0}}{{.Number}}{{end}}{{else if eq .Spec.Type "batch"}}/batch{{end}}/{{.Spec.Job}}/{{.Status.BuildID}}/'
  report_template: '[Full PR test history](http://prow.cncf.ci/pr-history?org={{.Spec.Refs.Org}}&repo={{.Spec.Refs.Repo}}&pr={{with index .Spec.Refs.Pulls 0}}{{.Number}}{{end}}). [Your PR dashboard](https://gubernator.cncf.ci/pr/{{with index .Spec.Refs.Pulls 0}}{{.Author}}{{end}}). Please help us cut down on flakes by [linking to](https://git.k8s.io/community/contributors/devel/flaky-tests.md#filing-issues-for-flaky-tests) an [open issue](https://github.com/{{.Spec.Refs.Org}}/{{.Spec.Refs.Repo}}/issues?q=is:issue+is:open) when you hit one in your PR.'
  job_url_prefix: http://prow.cncf.ci/view/gcs/
  pod_pending_timeout: 60m
  # level=fatal msg="Error loading Prow config." component=checkconfig error="no default decoration image pull specs provided for plank"
  default_decoration_config:
    timeout: 7200000000000 # 2h
    grace_period: 15000000000 # 15s
    utility_images:
      sidecar: "gcr.io/k8s-prow/sidecar:v20190506-d97b87848"
      clonerefs: "gcr.io/k8s-prow/clonerefs:v20190506-d97b87848"
      initupload: "gcr.io/k8s-prow/initupload:v20190506-d97b87848"
      entrypoint: "gcr.io/k8s-prow/entrypoint:v20190506-d97b87848"
    gcs_configuration:
      bucket: "apisnoop"
      path_strategy: "legacy"
      default_org: "cncf"
      default_repo: "apisnoop"
    gcs_credentials_secret: "service-account"
#+END_SRC
** periodics
#+BEGIN_SRC yaml
periodics:
- interval: 120m
  name: apisnoop-echo-test
  decorate: true
  spec:
    containers:
    - image: alpine
      command: ["/bin/date"]
#+END_SRC

** postsubmits
#+BEGIN_SRC yaml
postsubmits:
#+END_SRC
[[info:org#Editing%20source%20code][info:org#Editing source code]]
We may need to set org-src-preserve-identation...
[[info:org#Extracting%20source%20code][info:org#Extracting source code]]
Towards the bottom, theer is a section on Jumping between code and Org 
*** cncf/apisnoop
#+BEGIN_SRC yaml
  cncf/apisnoop:
#+END_SRC
**** apisnoop-postprocess-audits

This job runs only against commits and merges to master.
The script generates our data and uploads it to GCS.

#+BEGIN_SRC yaml
  - name: apisnoop-postprocess-audits
    branches:
    - master
    decorate: true
    skip_report: false
    spec:
      containers:
      - image: gcr.io/k8s-testimages/kubekins-e2e:v20190329-811f7954b-experimental
        command:
        - /bin/bash
        - -c
        args:
        - "./hack/ci/prow-production.sh"
        resources:
          requests:
            cpu: 3.5
            memory: "5Gi"
#+END_SRC
** presubmits


Memory usage is a bit high, could do with some optimization.
~3-4GB per python process... the parrallel processing on my 64GB laptop
#+BEGIN_SRC yaml
presubmits:
#+END_SRC
*** cncf/apisnoop
#+BEGIN_SRC yaml
  cncf/apisnoop:
#+END_SRC
**** apisnoop-process-audits
#+BEGIN_SRC yaml
  - name: apisnoop-process-audits
    branches:
    - master
    decorate: true
    skip_report: false
    always_run: true
    spec:
      containers:
      - image: gcr.io/k8s-testimages/kubekins-e2e:v20190329-811f7954b-experimental
        command:
        - /bin/bash
        - -c
        args:
        - "./hack/ci/prow-pr.sh"
        resources:
          requests:
            cpu: 3.5
            memory: "5Gi"
#+END_SRC
* OWNERS

[[https://go.k8s.io/owners]]
[[https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md]]

* debugging project plugin
  :PROPERTIES:
  :header-args:shell+: :dir ~/test-infra/
  :END:

** cards curls

#+BEGIN_SRC shell :wrap "SRC json"
  . ~/githubtoken
  curl --user hh:$GITHUB_TOKEN  -H "Accept:application/vnd.github.inertia-preview+json" \
  https://api.github.com/projects/columns/5090898/cards \
  | jq .[].id
  #https://api.github.com/projects/2501156/columns
#+END_SRC

#+RESULTS:
#+BEGIN_SRC json
20365896
20365897
#+END_SRC

#+BEGIN_SRC shell :wrap "SRC json"
  . ~/githubtoken
  curl --user hh:$GITHUB_TOKEN  -H "Accept:application/vnd.github.inertia-preview+json" \
  https://api.github.com/projects/columns/cards/20365897 \
  | jq -r .content_url
  #https://api.github.com/projects/2501156/columns
#+END_SRC

#+RESULTS:
#+BEGIN_SRC json
"https://api.github.com/repos/ii/apisnoop/issues/6"
#+END_SRC


** get secrets

*** hook secret

You need this for incoming secrets and to configure the github webhook or phony.

#+BEGIN_SRC shell
kubectl get secrets hmac-token -ojsonpath={.data.hmac} | base64 --decode > webhook-secret
#+END_SRC

*** oauth secret
#+BEGIN_SRC shell
kubectl get secrets oauth-token -ojsonpath={.data.oauth} | base64 --decode  > github-oauth
#+END_SRC

** hook config
 
Requres a checkout to ~/test-infra/hook-config.yaml
#+BEGIN_SRC yaml :tangle no
# I'm pretty sure we can use an empty config
#+END_SRC

** plugin config
~/test-infra/hook-plugin.yaml
#+BEGIN_SRC yaml :tangle no
  plugins:
    ii/apisnoop:
    - label
    # - project_manager
    - project
    - trigger
  project_config:
    project_org_configs:
      ii:
        org_maintainers_team_id: 3212487
        org_default_column_map:
          test-infra-dummy-testing-project-plugin:
            To do
          KEP Implementation Tracking:
            To do
        project_repo_configs:
          apisnoop:
            repo_default_column_map:
              triage:
                triage
              need-attention:
                attention
#+END_SRC

** run hook locally
  
It runs on port all your IPs on port 8888.
Adding ii.cncf.ci:8888 as a hook should work.

#+BEGIN_SRC tmate
  cd ~/test-infra
  <<hook secret>>
  <<oauth secret>>
  go run prow/cmd/hook/main.go \
     --deck-url=https://prow.k8s.io \
     --config-path=hook-config.yaml \
     --plugin-config=hook-plugin.yaml \
     --hmac-secret-file=webhook-secret \
     --github-token-path=github-oauth \
     --dry-run=false
#+END_SRC
** run phony

#+BEGIN_SRC tmate
bazel run //prow/cmd/phony -- \
  --address=http://localhost:8888/hook \
  --hmac=$(cat webhook-secret) \
  --event=issue_comment \
  --payload=$(pwd)/comment.json
#+END_SRC

** event
*** comment_body

#+BEGIN_SRC json
  /project test_project2 need-attention
#+END_SRC

*** payload
requires a checkout to ~/test-infra/comment.json
#+BEGIN_SRC json :noweb yes :tangle no
  {
    "action": "created",
    "issue": {
      "url": "https://api.github.com/repos/ii/apisnoop/issues/14",
      "repository_url": "https://api.github.com/repos/ii/apisnoop",
      "labels_url": "https://api.github.com/repos/ii/apisnoop/issues/14/labels{/name}",
      "comments_url": "https://api.github.com/repos/ii/apisnoop/issues/14/comments",
      "events_url": "https://api.github.com/repos/ii/apisnoop/issues/14/events",
      "html_url": "https://github.com/ii/apisnoop/issues/14",
      "id": 433492089,
      "node_id": "MDU6SXNzdWU0MzM0OTIwODk=",
      "number": 14,
      "title": "FOOBARBAZ",
      "user": {
        "login": "hh",
        "id": 31331,
        "node_id": "MDQ6VXNlcjMxMzMx",
        "avatar_url": "https://avatars2.githubusercontent.com/u/31331?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hh",
        "html_url": "https://github.com/hh",
        "followers_url": "https://api.github.com/users/hh/followers",
        "following_url": "https://api.github.com/users/hh/following{/other_user}",
        "gists_url": "https://api.github.com/users/hh/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hh/subscriptions",
        "organizations_url": "https://api.github.com/users/hh/orgs",
        "repos_url": "https://api.github.com/users/hh/repos",
        "events_url": "https://api.github.com/users/hh/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hh/received_events",
        "type": "User",
        "site_admin": false
      },
      "labels": [

      ],
      "state": "open",
      "locked": false,
      "assignee": null,
      "assignees": [

      ],
      "milestone": null,
      "comments": 171,
      "created_at": "2019-04-15T21:45:22Z",
      "updated_at": "2019-04-25T18:07:43Z",
      "closed_at": null,
      "author_association": "MEMBER",
      "body": "/woof"
    },
    "comment": {
      "url": "https://api.github.com/repos/ii/apisnoop/issues/comments/486779495",
      "html_url": "https://github.com/ii/apisnoop/issues/14#issuecomment-486779495",
      "issue_url": "https://api.github.com/repos/ii/apisnoop/issues/14",
      "id": 486779496,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ4Njc3OTQ5NQ==",
      "user": {
        "login": "hh",
        "id": 31331,
        "node_id": "MDQ6VXNlcjMxMzMx",
        "avatar_url": "https://avatars2.githubusercontent.com/u/31331?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/hh",
        "html_url": "https://github.com/hh",
        "followers_url": "https://api.github.com/users/hh/followers",
        "following_url": "https://api.github.com/users/hh/following{/other_user}",
        "gists_url": "https://api.github.com/users/hh/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/hh/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hh/subscriptions",
        "organizations_url": "https://api.github.com/users/hh/orgs",
        "repos_url": "https://api.github.com/users/hh/repos",
        "events_url": "https://api.github.com/users/hh/events{/privacy}",
        "received_events_url": "https://api.github.com/users/hh/received_events",
        "type": "User",
        "site_admin": false
      },
      "created_at": "2019-04-25T18:07:43Z",
      "updated_at": "2019-04-25T18:07:43Z",
      "author_association": "MEMBER",
      "body": "<<comment_body>>"
    },
    "repository": {
      "id": 145496821,
      "node_id": "MDEwOlJlcG9zaXRvcnkxNDU0OTY4MjE=",
      "name": "apisnoop",
      "full_name": "ii/apisnoop",
      "private": false,
      "owner": {
        "login": "ii",
        "id": 30447,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjMwNDQ3",
        "avatar_url": "https://avatars2.githubusercontent.com/u/30447?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ii",
        "html_url": "https://github.com/ii",
        "followers_url": "https://api.github.com/users/ii/followers",
        "following_url": "https://api.github.com/users/ii/following{/other_user}",
        "gists_url": "https://api.github.com/users/ii/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/ii/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ii/subscriptions",
        "organizations_url": "https://api.github.com/users/ii/orgs",
        "repos_url": "https://api.github.com/users/ii/repos",
        "events_url": "https://api.github.com/users/ii/events{/privacy}",
        "received_events_url": "https://api.github.com/users/ii/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/ii/apisnoop",
      "description": "Snooping on the Kubernetes OpenAPI communications",
      "fork": true,
      "url": "https://api.github.com/repos/ii/apisnoop",
      "forks_url": "https://api.github.com/repos/ii/apisnoop/forks",
      "keys_url": "https://api.github.com/repos/ii/apisnoop/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/ii/apisnoop/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/ii/apisnoop/teams",
      "hooks_url": "https://api.github.com/repos/ii/apisnoop/hooks",
      "issue_events_url": "https://api.github.com/repos/ii/apisnoop/issues/events{/number}",
      "events_url": "https://api.github.com/repos/ii/apisnoop/events",
      "assignees_url": "https://api.github.com/repos/ii/apisnoop/assignees{/user}",
      "branches_url": "https://api.github.com/repos/ii/apisnoop/branches{/branch}",
      "tags_url": "https://api.github.com/repos/ii/apisnoop/tags",
      "blobs_url": "https://api.github.com/repos/ii/apisnoop/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/ii/apisnoop/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/ii/apisnoop/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/ii/apisnoop/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/ii/apisnoop/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/ii/apisnoop/languages",
      "stargazers_url": "https://api.github.com/repos/ii/apisnoop/stargazers",
      "contributors_url": "https://api.github.com/repos/ii/apisnoop/contributors",
      "subscribers_url": "https://api.github.com/repos/ii/apisnoop/subscribers",
      "subscription_url": "https://api.github.com/repos/ii/apisnoop/subscription",
      "commits_url": "https://api.github.com/repos/ii/apisnoop/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/ii/apisnoop/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/ii/apisnoop/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/ii/apisnoop/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/ii/apisnoop/contents/{+path}",
      "compare_url": "https://api.github.com/repos/ii/apisnoop/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/ii/apisnoop/merges",
      "archive_url": "https://api.github.com/repos/ii/apisnoop/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/ii/apisnoop/downloads",
      "issues_url": "https://api.github.com/repos/ii/apisnoop/issues{/number}",
      "pulls_url": "https://api.github.com/repos/ii/apisnoop/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/ii/apisnoop/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/ii/apisnoop/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/ii/apisnoop/labels{/name}",
      "releases_url": "https://api.github.com/repos/ii/apisnoop/releases{/id}",
      "deployments_url": "https://api.github.com/repos/ii/apisnoop/deployments",
      "created_at": "2018-08-21T02:40:29Z",
      "updated_at": "2019-03-19T19:24:31Z",
      "pushed_at": "2019-03-19T19:27:29Z",
      "git_url": "git://github.com/ii/apisnoop.git",
      "ssh_url": "git@github.com:ii/apisnoop.git",
      "clone_url": "https://github.com/ii/apisnoop.git",
      "svn_url": "https://github.com/ii/apisnoop",
      "homepage": null,
      "size": 18662,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "CSS",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": true,
      "has_wiki": true,
      "has_pages": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 10,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "forks": 0,
      "open_issues": 10,
      "watchers": 0,
      "default_branch": "master"
    },
    "organization": {
      "login": "ii",
      "id": 30447,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjMwNDQ3",
      "url": "https://api.github.com/orgs/ii",
      "repos_url": "https://api.github.com/orgs/ii/repos",
      "events_url": "https://api.github.com/orgs/ii/events",
      "hooks_url": "https://api.github.com/orgs/ii/hooks",
      "issues_url": "https://api.github.com/orgs/ii/issues",
      "members_url": "https://api.github.com/orgs/ii/members{/member}",
      "public_members_url": "https://api.github.com/orgs/ii/public_members{/member}",
      "avatar_url": "https://avatars2.githubusercontent.com/u/30447?v=4",
      "description": "inclusively integrating the world"
    },
    "sender": {
      "login": "hh",
      "id": 31331,
      "node_id": "MDQ6VXNlcjMxMzMx",
      "avatar_url": "https://avatars2.githubusercontent.com/u/31331?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hh",
      "html_url": "https://github.com/hh",
      "followers_url": "https://api.github.com/users/hh/followers",
      "following_url": "https://api.github.com/users/hh/following{/other_user}",
      "gists_url": "https://api.github.com/users/hh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hh/subscriptions",
      "organizations_url": "https://api.github.com/users/hh/orgs",
      "repos_url": "https://api.github.com/users/hh/repos",
      "events_url": "https://api.github.com/users/hh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hh/received_events",
      "type": "User",
      "site_admin": false
    }
  }
#+END_SRC
** flow
*** restart

#+BEGIN_SRC tmate
  kubectl delete pods --namespace=default -l app=hook
#+END_SRC

*** logging

xargs -n 1 limits it to running one line at a time rather than multiple
xargs -P 5 enables mulitple processes, so in parallel

#+BEGIN_SRC tmate
  kubectl get pods --namespace=default -l app=hook -o name \
  | sed s:pod/:: \
  | xargs -n 1 -P 5 kubectl logs -f \
  | grep -v /etc/config/config.yaml \
  | jq -c -S
#+END_SRC

*** comment
Documentation for ~/project~ command:
https://prow.k8s.io/command-help

#+BEGIN_EXAMPLE
/project 0.5.0
/project 0.5.0 To do
/project clear 0.4.0
#+END_EXAMPLE

#+BEGIN_SRC note
/project test_project
#+END_SRC

** projects

1 test_project
2 test_project2
3 Projects Documentation

- [ ] list projects
- [ ] list project boards

* PR Status
[[https://github.com/kubernetes/test-infra/blob/master/prow/docs/pr_status_setup.md#how-to-setup-pr-status]]
*** github oauth app
**** secret/cookie

#+NAME: create github oauth cookie
#+BEGIN_SRC shell
  openssl rand -base64 64 > cookie
  kubectl create secret generic cookie \
    --from-file=secret=cookie
  # one liner attempt, that removes newlines to get a simple secret
  # kubectl create secret generic cookie \
  #   --from-literal=secret=$(openssl rand -base64 64 | tr -d "\n")
#+END_SRC

#+RESULTS: create github oauth cookie
#+BEGIN_EXAMPLE :noeval t
secret/cookie created
#+END_EXAMPLE

#+NAME: get secret/cookie
#+BEGIN_SRC shell :results silent
  kubectl get secret cookie  -o json | jq -r .data.secret | base64 -d
#+END_SRC

**** secret/github-oauth-config

#+NAME: github-oauth-config
#+BEGIN_SRC conf :tangle github-oauth-config
client_id: e4d9651867ae7a0f2d21
client_secret: XXXXX
redirect_url: http://prow.cncf.ci/github-login/redirect
final_redirect_url: http://prow.cncf.ci/pr
#+END_SRC

#+NAME: create secret/github-oauth-config
#+BEGIN_SRC shell
  kubectl create secret generic github-oauth-config \
    --from-file=secret=github-oauth-config
#+END_SRC

#+RESULTS: create secret/github-oauth-config
#+BEGIN_EXAMPLE :noeval t
secret/github-oauth-config created
#+END_EXAMPLE

#+NAME: gihub oauth-token
#+BEGIN_SRC shell :results silent
kubectl get secret github-oauth-config -o json | jq -r .data.secret | base64 -d
#+END_SRC
** Fix Oauth secret state

When visiting http://prow.cncf.ci/pr when we return from github/oauth to /github-login/redirect?code=X&state=Y we get the following error:

> 500 Internal server error Get secret state: empty string or cannot convert to string

Looking at the logs it might be related to the secrets:

#+BEGIN_EXAMPLE
kubectl log -f $(kubectl get pods --namespace=default -l app=deck -o name | tail -1 )
log is DEPRECATED and will be removed in a future version. Use logs instead.
time="2019-03-19T17:55:40Z" level=info msg="Spyglass registered viewer build-log-viewer with title Build Log." 
time="2019-03-19T17:55:40Z" level=info msg="Spyglass registered viewer junit-viewer with title JUnit." 
time="2019-03-19T17:55:40Z" level=info msg="Spyglass registered viewer metadata-viewer with title Metadata." 
{"client":"githuboauth","component":"deck","error":"empty string or cannot convert to string","level":"error","msg":"Error Get secret state.","time":"2019-03-19T17:56:48Z"}
{"client":"githuboauth","component":"deck","error":"empty string or cannot convert to string","level":"error","msg":"Error Get secret state.","time":"2019-03-19T17:56:53Z"}
^C
#+END_EXAMPLE

I ensured the secrets relating to oauth are in the correct place (as documented)

#+BEGIN_EXAMPLE
$ kubectl exec -ti $(kubectl get pods --namespace=default -l app=deck -o name | tail -1 | sed s:pod/::) /bin/sh
/app/prow/cmd/deck/app.binary.runfiles/test_infra # cat /etc/github/secret 
client_id: e4d9651867ae7a0f2d21
client_secret: 47XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXbb1
redirect_url: http://prow.cncf.ci/github-login/redirect
final_redirect_url: http://prow.cncf.ci/pr
/app/prow/cmd/deck/app.binary.runfiles/test_infra # cat /etc/cookie/secret 
wVXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXIX
sXXXXXXXXXXXXXXXXXXXXXXXXXXXXX==
#+END_EXAMPLE

Then I wanted to ensure it was looking in the locations I mounted them at.
(There are some command lines args for deck that enable it)

#+BEGIN_SRC yaml
      containers:
      - name: deck
        image: gcr.io/k8s-prow/deck:v20181109-1a84354
        args:
        - --tide-url=http://tide/
        - --hook-url=http://hook:8888/plugin-help
        - --oauth-url=/github-login
        - --github-oauth-config-file=/etc/github/secret
        - --cookie-secret=/etc/cookie/secret
        - --spyglass
#+END_SRC

After the Deployment recreated the pods with now args, I verified, but still got the same error:

#+BEGIN_EXAMPLE
/app/prow/cmd/deck/app.binary.runfiles/test_infra
# cat /proc/1/cmdline | sed s/--/\\n--/g
/app/prow/cmd/deck/app.binary
--tide-url=http://tide/
--hook-url=http://hook:8888/plugin-help
--oauth-url=/github-login
--github-oauth-config-file=/etc/github/secret
--cookie-secret=/etc/cookie/secret
--spyglass
#+END_EXAMPLE

* testgrid
https://k8s-testgrid.appspot.com/
https://k8s-testgrid.appspot.com/conformance-gce
[[https://k8s-testgrid.appspot.com/conformance-gce#GCE,%2520master%2520(dev)]]
Click on see these results in prow:

https://prow.k8s.io/job-history/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance
 
https://github.com/kubernetes/test-infra/tree/master/testgrid#testgrid
https://github.com/kubernetes/test-infra/blob/master/testgrid/config.yaml


[[https://github.com/kubernetes/test-infra/blob/master/testgrid/config.yaml#L50][testgrid/config.yaml#testgroups]]
#+NAME: testgrid test_group ci-kubernetes-gce-conformance
#+BEGIN_SRC yaml :tangle no
  #
  # Start testgroups
  #
  test_groups:
  # ... skipping lines ...
  # Prow hosted conformance tests
  - name: ci-kubernetes-gce-conformance
    gcs_prefix: kubernetes-jenkins/logs/ci-kubernetes-gce-conformance
    num_columns_recent: 3
    alert_stale_results_hours: 24
    num_failures_to_alert: 1
#+END_SRC

#+NAME: testgrid dashboard_tab: conformance-gce / GCE, master (dev)
#+BEGIN_SRC yaml
- name: conformance-gce
  dashboard_tab:
  - name: GCE, master (dev)
    description: Runs conformance tests using kubetest against latest kubernetes master CI build on GCE
    test_group_name: ci-kubernetes-gce-conformance
#+END_SRC

Looks like this runs four times a day.

* prow
Prow has many binaries and components.
Most are listed here:
https://github.com/kubernetes/test-infra/tree/master/prow/cmd

Job History: logs/ci-kubernetes-gce-conformance
https://prow.k8s.io/job-history/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance
https://prow.k8s.io/view/gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance/1114942954738290692
Gubernator, used to be used, but now we default to spyglass.
** jobs
[[https://github.com/kubernetes/test-infra/blob/master/config/jobs/kubernetes/sig-gcp/gce-conformance.yaml][config/jobs/kubernetes/sig-gcp/gce-conformance.yaml]]
#+BEGIN_SRC yaml :tangle no
  periodics:
  - interval: 6h
    name: ci-kubernetes-gce-conformance
    labels:
      preset-service-account: "true"
      preset-k8s-ssh: "true"
    spec:
      containers:
      - args:
        - --timeout=220
        - --bare
        - --scenario=kubernetes_e2e
        - --
        - --extract=ci/latest
        - --gcp-master-image=gci
        - --gcp-node-image=gci
        - --gcp-zone=us-west1-b
        - --provider=gce
        - --test_args=--ginkgo.focus=\[Conformance\] --ginkgo.skip=Alpha|\[(Disruptive|Feature:[^\]]+|Flaky)\]
        - --timeout=200m
        image: gcr.io/k8s-testimages/kubekins-e2e:v20190329-811f7954b-master
#+END_SRC
** kubekins
   Wrapper to kubetest
[[https://github.com/kubernetes/test-infra/blob/master/images/kubekins-e2e/kops-e2e-runner.sh#L91][images/kubekins-e2e/kops-e2e-runner.sh#L91]]
** kubetest
   Used to build, deploy, and run k8s tests
   https://github.com/kubernetes/test-infra/tree/master/kubetest#kubetest
** deck uses spyglass to render/view artifacts
[[https://github.com/kubernetes/test-infra/blob/master/prow/config.yaml#L26][prow/config.yaml#L26]]
#+BEGIN_SRC yaml
deck:
  spyglass:
    size_limit: 500000000 # 500MB
    gcs_browser_prefix: https://gcsweb.k8s.io/gcs/
    testgrid_config: gs://k8s-testgrid/config
    testgrid_root: https://testgrid.k8s.io/
    viewers:
      "started.json|finished.json":
      - "metadata"
      "build-log.txt":
      - "buildlog"
      "artifacts/junit.*\\.xml":
      - "junit"
    announcement: "The old job viewer, Gubernator, has been deprecated in favour of this page, Spyglass.{{if .ArtifactPath}} For now, the old page is <a href='https://gubernator.k8s.io/build/{{.ArtifactPath}}'>still available</a>.{{end}} Please send feedback to sig-testing."
  tide_update_period: 1s
  hidden_repos:
  - kubernetes-security
  google_analytics: UA-82843984-5
#+END_SRC
** spyglass :: pluggable artifact viewer framework for Prow
   https://github.com/kubernetes/test-infra/tree/master/prow/spyglass#spyglass
   A general Spyglass query will proceed as follows:

- User provides a job source in the query (usually a job name and build ID).
- Spyglass finds all artifact names associated with the given job source.
- Spyglass builds a cache of which artifacts match which lenses via configured regular expressions.
- Lenses with matching artifacts are pre-rendered in order of descending priority.
- Spyglass then sends render requests to each registered lens with its matching artifacts.
- Each lens performs any necessary operations on the artifacts and produces a blob of HTML.
- Views (HTML) are inserted asynchronously as viewers return.
[[https://github.com/kubernetes/test-infra/blob/master/prow/cmd/deck/template/spyglass.html][prow/cmd/dock/template/spyglass.html]]
[[https://github.com/kubernetes/test-infra/tree/master/prow/spyglass#available-views][Available Views]]
*** Lenses :: set of functions that consume a list of artifacts and produces some HTML.
[[https://github.com/kubernetes/test-infra/tree/master/prow/spyglass#built-in-viewers][Built In Viewers]]
**** metadata
Clicking on more / less info pops down details.
**** junit
Shows Tests Skpipped and Passed!
**** Build Log
Link to raw build-log.txt
Default only shows lines with ERROR, but can show more.
*** Building our own Lense  Write Boiler Plate
- [ ] Implement
- [ ] Add to config
https://github.com/kubernetes/test-infra/tree/master/prow/spyglass#config
**** Debugging the prow / deck / spyclass instance

#+NAME: retrieve deck logs
#+BEGIN_SRC shell
  #kubectl logs --namespace=default -l app=deck
  kubectl get pods -l app=deck -o name | xargs -n 1 kubectl logs -f --namespace=default
#+END_SRC

#+NAME: invalid view names
#+BEGIN_EXAMPLE
{"component":"deck","duration":277252565,"level":"info","msg":"Listed 55 artifacts.","time":"2019-04-07T22:52:21Z"}
{"component":"deck","error":"invalid view name","level":"error","msg":"Could not find artifact viewer","time":"2019-04-07T22:52:21Z",
"viewName":"junit"}
{"component":"deck","error":"invalid view name","level":"error","msg":"Could not find artifact viewer","time":"2019-04-07T22:52:21Z",
"viewName":"buildlog"}
{"component":"deck","error":"invalid view name","level":"error","msg":"Could not find artifact viewer","time":"2019-04-07T22:52:21Z",
"viewName":"metadata"}
{"component":"deck","level":"info","msg":"job history link: /job-history/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance","time":"2019-04-07T22:52:21Z"}
{"component":"deck","duration":"278.817799ms","level":"info","msg":"Rendered spyglass views.","source":"gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance/1114942954738290692","time":"2019-04-07T22:52:21Z"}
{"component":"deck","duration":"279.194765ms","endpoint":"/view/gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance/1114942954738290692","level":"info","msg":"Loading view completed.","source":"gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance/1114942954738290692","time":"2019-04-07T22:52:21Z"}
#+END_EXAMPLE
**** implement
    https://github.com/kubernetes/test-infra/tree/master/prow/spyglass#implementa

#+NAME: Lens.Interface
#+BEGIN_SRC go
type Lens interface {
	// Config returns the name, title, priority, and other information about your lens.
	Config() LensConfig
	// Header is used to inject content into the lens's <head>. It will only ever be called once per load.
	Header(artifacts []Artifact, resourceDir string) string
	// Body is used to generate the contents of the lens's <body>. It will initially be called with empty data, but
	// the lens front-end code may choose to re-render itself with custom data.
	Body(artifacts []Artifact, resourceDir string, data string) string
	// Callback is used for the viewer to exchange arbitrary data with the frontend. It is called with lens-specified
	// data, and returns data to be passed to the lens. JSON encoding is recommended in both directions.
	Callback(artifacts []Artifact, resourceDir string, data string) string
}
#+END_SRC

In the init method, call lenses.RegisterLens() with an instance of your implementation of the interface.
Spyglass should now be aware of your lens.

Additionally, some front-end TypeScript code can be provided.
Configure your BUILD.bazel to build it,
then emit a <script> tag with a relative reference to it in your Header() implementation.
See buildlog/BUILD.bazel for an example.

In your typescript code, a global spyglass object will be available, providing the following interface:

#+BEGIN_SRC js
export interface Spyglass {
  /**
   * Replaces the lens display with a new server-rendered page.
   * The returned promise will be resolved once the page has been updated.
   */
  updatePage(data: string): Promise<void>;
  /**
   * Requests that the server re-render the lens with the provided data, and
   * returns a promise that will resolve with that HTML as a string.
   *
   * This is equivalent to updatePage(), except that the displayed content is
   * not automatically changed.
   */
  requestPage(data: string): Promise<string>;
  /**
   * Sends a request to the server-side lens backend with the provided data, and
   * returns a promise that will resolve with the response as a string.
   */
  request(data: string): Promise<string>;
  /**
   * Inform Spyglass that the lens content has updated. This should be called whenever
   * the visible content changes, so Spyglass can ensure that all content is visible.
   */
  contentUpdated(): void;
}
#+END_SRC
** gcsweb
Allow anyone to browse GCS files / buckets?
https://gcsweb.k8s.io/gcs/kubernetes-jenkins/logs/ci-kubernetes-gce-conformance/1114942954738290692/
** build status on source.google.cloud.com
https://source.cloud.google.com/results/invocations/0b8cf342-71f9-4ede-a665-2ac712beb20a/targets/test/tests;group=Kubernetes%20e2e%20suite%20k8s.io%20LinuxOnly%20NodeConformance%20Conformance;test=KubeletManagedEtcHosts%20should%20test%20kubelet%20managed%20%2Fetc%2Fhosts%20file;row=17
* Logging
#+BEGIN_SRC tmate
gsutil ls -laR gs://apisnoop/pr-logs/pull/ii-ci_apisnoop/3/apisnoop-hack-presubmit
#+END_SRC
#+BEGIN_SRC tmate
kubectl logs \
  -c test \
  $(\
  kubectl get pods \
  -l prow.k8s.io/id=2d8e7349-69d6-11e9-b74d-0a580a0c011f \
  -o name\
  )
#+END_SRC
#+BEGIN_SRC tmate
kubectl logs \
  -c sidecar \
  $(\
  kubectl get pods \
  -l prow.k8s.io/id=2d8e7349-69d6-11e9-b74d-0a580a0c011f \
  -o name\
  ) \
  | jq . -c
#+END_SRC
* Developing spyglass
Dependencies - Bazel 0.23.0

#+BEGIN_SRC tmate
cd ~/test-infra/prow/cmd/deck
./runlocal
#+END_SRC

#+BEGIN_SRC shell
sed -i sXhttps://prow.k8s.ioXhttp://localhost:8080Xg ../../config.yaml
sed -i sXhttps://prow.k8s.ioXhttp://localhost:8080Xg ./localdata/*js

#+END_SRC
#+RESULTS:
#+BEGIN_EXAMPLE :noeval t
#+END_EXAMPLE

Visit http://localhost:8080

* Footnotes

#+PROPERTY: header-args:shell :results output code verbatim replace
#+PROPERTY: header-args:shell+ :exports both
#+PROPERTY: header-args:shell+ :wrap "EXAMPLE :noeval t"
#+PROPERTY: header-args:shell+ :eval no-export
#+PROPERTY: header-args:shell+ :noweb-ref (nth 4 (org-heading-components))
#+PROPERTY: header-args:tmate  :socket (symbol-value 'socket)
#+PROPERTY: header-args:tmate+ :session (concat (user-login-name) ":" (nth 4 (org-heading-components)))
#+PROPERTY: header-args:tmate+ :noweb yes
#+PROPERTY: header-args:json  :noweb yes
#+PROPERTY: header-args:json+ :noweb-ref (nth 4 (org-heading-components))
#+PROPERTY: header-args:yaml  :noweb yes
#+PROPERTY: header-args:yaml+ :nocomments org
#+PROPERTY: header-args:yaml+ :noweb-ref (nth 4 (org-heading-components))
#+REVEAL_ROOT: http://cdn.jsdelivr.net/reveal.js/3.0.0/
#+STARTUP: content
# Local Variables:
# eval: (set (make-local-variable 'org-file-dir) (file-name-directory buffer-file-name))
# eval: (set (make-local-variable 'user-buffer) (concat user-login-name "." (file-name-base buffer-file-name)))
# eval: (set (make-local-variable 'tmpdir) (make-temp-file (concat "/dev/shm/" user-buffer "-") t))
# eval: (set (make-local-variable 'socket) (concat "/tmp/" user-buffer ".iisocket"))
# eval: (set (make-local-variable 'select-enable-clipboard) t)
# eval: (set (make-local-variable 'select-enable-primary) t)
# eval: (set (make-local-variable 'start-tmate-command) (concat "tmate -S " socket " new-session -A -s " user-login-name " -n main \"tmate wait tmate-ready && tmate display -p '#{tmate_ssh}' | xclip -i -sel p -f | xclip -i -sel c; bash --login\""))
# eval: (xclip-mode 1)
# eval: (gui-select-text start-tmate-command)
# eval: (xclip-mode 1)
# org-babel-tmate-session-prefix: ""
# org-babel-tmate-default-window-name: "main"
# org-use-property-inheritance: t
# End:

